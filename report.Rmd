---
title: "Report PVA"
output: 
  html_document:
    code_folding: hide
params:
    data_subset: NA
    tv_all_plot_type: NA
    tv_all_plot_style: NA
    tv_all_interpolate: NA
    tv_all_plotType: NA
    tv_all_scaleby: NA
    tv_all_endpoint_scale: NA
    tv_weight_plot_type: NA
    tv_weight_plot_style: NA
    tv_weight_plotType: NA
---

```{r, results='hide'}
source("server/report-logic.R", local = knitr::knit_global())
```


```{r base volume plot, fig.width = 10}
 
    plot_data <- params$data_subset

    if (params$tv_all_plot_type == "Treatment Plot") {
        pattern_type <- "Treatment"
    } else if (params$tv_all_plot_type == "Study Plot") {
        pattern_type <- "Study"
    }

    if (params$tv_all_plot_style == "Study Average") {
        level_type <- "Arm"
    } else if (params$tv_all_plot_style == "Individual Animal") {
        level_type <- "Animal"
    }
    # interpolate the data if asked for.
    if (params$tv_all_interpolate){
        plot_data = get_interpolated_pdx_data(data = plot_data)
        plot_data$Volume <- plot_data$Interpolated_Volume
    }

        #Adjust the data to semi-log if asked for.
    if (params$tv_all_plotType == 'Log2(Volume)'){
        plot_data$Volume <- log2(1 + plot_data$Volume)

        # Adjust the data to percent change the data if asked for
    } else if (params$tv_all_plotType == 'Percent Change') {
        plot_data <- plot_data %>%
            dplyr::arrange(Contributor, Study, Tumor, Arms, ID, Times) %>%
            dplyr::group_by(Contributor, Study, Tumor, Arms, ID) %>%
            dplyr::mutate(dVt = (((Volume - Volume[1]) / Volume[1] ) * 100))
        plot_data$Volume <- plot_data$dVt

        # Adjust to semi-log of prop change if asked for
    } else if (params$tv_all_plotType == 'Log2(Proportion Volume Change)') {
        plot_data <- plot_data %>%
            dplyr::arrange(Contributor, Study, Tumor, Arms, ID, Times) %>%
            dplyr::group_by(Contributor, Study, Tumor, Arms, ID) %>%
            dplyr::mutate(log2.dVt = log2(1 + ((Volume - Volume[1]) / Volume[1])))
        plot_data$Volume <- plot_data$log2.dVt
    }

    # Call plot
    if (params$tv_all_plotType == 'Scaled') {
        if(params$tv_all_scaleby == "Volume") {
        scale_by_volume_all <- TRUE

        tv_all_text_scaled <- renderText({
            paste0("Plots are scaled by Volume. Y-axis ranges from 100% with endpoint scaling of ",
                params$tv_all_endpoint_scale,
                "mm3 to -100% (total regression)")
        })

        } else {
        scale_by_volume_all <- FALSE

        tv_all_text_scaled <- renderText({
            paste0("Plots are scaled by Relative Growth. Y-axis ranges from 100% with endpoint scaling of ",
                params$tv_all_endpoint_scale,
                "x starting growth to -100% (total regression)")
        })
        }

        endpoint_scale_all <- params$tv_all_endpoint_scale

        ggplotly(get_plot_scaled(data = plot_data, position.dodge = 0.2,  title = NULL, scale.factor = endpoint_scale_all, scale.by.volume = scale_by_volume_all, level = level_type, pattern = pattern_type, tv_all_plotType = params$tv_all_plotType))

    } else {

        # Reset Info Text of the Scaled Plot
        tv_all_text_scaled <- renderText({""})

        ggplotly(get_tv_plot(data = plot_data, level = level_type, pattern = pattern_type, position.dodge = 0.2, tv_all_plotType = params$tv_all_plotType))
    }

    shiny::setProgress(0.5)
```








```{r Body_Weight, fig.width = 10}
    #   # Get Level Type Input by User
    if (params$tv_weight_plot_type == "Treatment Plot") {
        pattern_type <- "Treatment"
    } else if (params$tv_weight_plot_type == "Study Plot") {
        pattern_type <- "Study"
    }

    if (params$tv_weight_plot_style == "Study Average") {
        level_type <- "Arm"
    } else if (params$tv_weight_plot_style == "Individual Animal") {
        level_type <- "Animal"
    }

    if (params$tv_weight_plotType == 'Percent Change'){
        data <- params$data_subset %>%
            dplyr::arrange(Study, Tumor, Arms, ID, Times) %>%
            dplyr::group_by(Study, Tumor, Arms, ID) %>%
            dplyr::mutate(dWeight = (((Body_Weight - Body_Weight[1]) / Body_Weight[1] ) * 100))

        data$Body_Weight <- params$data$dWeight
    } else {
        data <- params$data_subset
    }
    #   # Call plot
    ggplotly(get_weight_plot(data = data, level = level_type, pattern = pattern_type, position.dodge = 0.2, tv_weight_plotType = params$tv_weight_plotType))
    
    shiny::setProgress(1)
```