---
title: "Report PVA"

output: 
  pdf_document:
    toc: true
    toc_depth: 5
    fig_width: 9
    fig_height: 7
    df_print: kable
    
params:
    data_subset: NA
    tv_all_plot_type: NA
    tv_all_plot_style: NA
    tv_all_interpolate: NA
    tv_all_plotType: NA
    tv_all_scaleby: NA
    tv_all_endpoint_scale: NA
    main_avgplot_interpolate: NA
    main_avgplot.day: NA
    main_log2fold.day: NA
    main_log2_interpolate: NA
    main_TC.day: NA
    main_tc_interpolate: NA
    main_TGI.day: NA
    main_tgi_interpolate: NA
    main_orc.day: NA
    main_stackedorc_interpolate: NA
    tv_recist.day: NA
    tv_study_filtered: NA
    tv_interpolate: NA
    waterfall_metric: NA
    tv_AUC.day.waterfall: NA
    tv_PercChange_EventSize: NA
    anova_Measure_Day: NA
    tv_tumor_filtered: NA
    main_anova_interpolate: NA
    tv_waterfall_interpolate: NA
    tv_weight_plot_type: NA
    tv_weight_plot_style: NA
    tv_weight_plotType: NA

always_allow_html: yes

---

# Report

```{r load functions, results='hide', echo=FALSE}
    source("../server/logic-plots.R", local = knitr::knit_global())
```

```{r, echo=FALSE}
# print(params)

# Stub code for adding plots / tables. from main data

# ```{r }

#     plot_data <- params$data_subset

#     shiny::setProgress(0.3)
# ```

# Stub code for adding plots /tables from single selected studies

# ```{r }

#     df <- base::subset(
#     params$data_subset, Study %in% c(params$tv_study_filtered)
#     )
    
#     shiny::setProgress(0.3)
# ```

```

```{r, results='asis', echo=FALSE}

cat("This report was generated with the PVA tool on: ", format(Sys.time(), "%m.%d.%Y at %Hh:%Mm"), '\n\n\n')

cat("Included in this report is data from ",
    length(unique(params$data_subset$"Contributor")),
    "contributing institution(s), ",
    length(unique(params$data_subset$"ID")),
    "individual animals, ",
    length(unique(params$data_subset$"Study")),
    "studie(s), ",
    length(unique(params$data_subset$"Tumor")),
    "tumor(s) [model(s)] from ",
    length(unique(params$data_subset$"Disease_Type")),
    "disease type(s), which were treated with ",
    length(unique(params$data_subset$"Arms")),
    "agents (control included.")

```

## Cross Study Plots & Analysis

A Summary of cross study plots and analyses.

### Response Plot

```{r base volume plot, echo=FALSE}
 
    plot_data <- params$data_subset

    if (params$tv_all_plot_type == "Treatment Plot") {
        pattern_type <- "Treatment"
    } else if (params$tv_all_plot_type == "Study Plot") {
        pattern_type <- "Study"
    }

    if (params$tv_all_plot_style == "Study Average") {
        level_type <- "Arm"
    } else if (params$tv_all_plot_style == "Individual Animal") {
        level_type <- "Animal"
    }
    # interpolate the data if asked for.
    if (params$tv_all_interpolate){
        plot_data = get_interpolated_pdx_data(data = plot_data)
        plot_data$Volume <- plot_data$Interpolated_Volume
    }

        #Adjust the data to semi-log if asked for.
    if (params$tv_all_plotType == 'Log2(Volume)'){
        plot_data$Volume <- log2(1 + plot_data$Volume)

        # Adjust the data to percent change the data if asked for
    } else if (params$tv_all_plotType == 'Percent Change') {
        plot_data <- plot_data %>%
            dplyr::arrange(Contributor, Study, Tumor, Arms, ID, Times) %>%
            dplyr::group_by(Contributor, Study, Tumor, Arms, ID) %>%
            dplyr::mutate(dVt = (((Volume - Volume[1]) / Volume[1] ) * 100))
        plot_data$Volume <- plot_data$dVt

        # Adjust to semi-log of prop change if asked for
    } else if (params$tv_all_plotType == 'Log2(Proportion Volume Change)') {
        plot_data <- plot_data %>%
            dplyr::arrange(Contributor, Study, Tumor, Arms, ID, Times) %>%
            dplyr::group_by(Contributor, Study, Tumor, Arms, ID) %>%
            dplyr::mutate(log2.dVt = log2(1 + ((Volume - Volume[1]) / Volume[1])))
        plot_data$Volume <- plot_data$log2.dVt
    }

    # Call plot
    if (params$tv_all_plotType == 'Scaled') {
        if(params$tv_all_scaleby == "Volume") {
        scale_by_volume_all <- TRUE

        tv_all_text_scaled <- renderText({
            paste0("Plots are scaled by Volume. Y-axis ranges from 100% with endpoint scaling of ",
                params$tv_all_endpoint_scale,
                "mm3 to -100% (total regression)")
        })

        } else {
        scale_by_volume_all <- FALSE

        tv_all_text_scaled <- renderText({
            paste0("Plots are scaled by Relative Growth. Y-axis ranges from 100% with endpoint scaling of ",
                params$tv_all_endpoint_scale,
                "x starting growth to -100% (total regression)")
        })
        }

        endpoint_scale_all <- params$tv_all_endpoint_scale

        get_plot_scaled(data = plot_data, position.dodge = 0.2,  title = NULL, scale.factor = endpoint_scale_all, scale.by.volume = scale_by_volume_all, level = level_type, pattern = pattern_type, tv_all_plotType = params$tv_all_plotType)

    } else {

        # Reset Info Text of the Scaled Plot
        tv_all_text_scaled <- renderText({""})

        get_tv_plot(data = plot_data, level = level_type, pattern = pattern_type, position.dodge = 0.2, tv_all_plotType = params$tv_all_plotType)
    }
    
    shiny::setProgress(0.1)

```

```{r response plot option text, results='asis', echo=FALSE}

    cat("The response plot metric: ")
    cat(paste("**",params$tv_all_plotType,"**",sep=""))
    cat(", was faceted by: ")
    cat(paste("**",params$tv_all_plot_type,"**",sep=""))
    cat(", plots were organized by: ")
    cat(paste("**",params$tv_all_plot_style,"**. ",sep=""))

    if (params$tv_all_plotType == 'Scaled') {
        if(params$tv_all_scaleby == "Volume") {        
            cat(paste0("Plots are scaled by **Volume**. Y-axis ranges from 100% with endpoint scaling of ",
                "**",params$tv_all_endpoint_scale,"**",
                "**mm3** to -100% (total regression). "))
        } else {
            cat(paste0("Plots are scaled by **Relative Growth**. Y-axis ranges from 100% with endpoint scaling of ",
                "**",params$tv_all_endpoint_scale,"**",
                "**x** starting growth to -100% (total regression). "))
        }
    }

    if (params$tv_all_interpolate) {
        print("Data were interpolated for this plot.")
    }

```

### Average Volume Plot

```{r avg volume plot, echo=FALSE}
    
    plot_data <- params$data_subset

    if (params$main_avgplot_interpolate){
        plot_data <- get_interpolated_pdx_data(data = plot_data)
        plot_data$Volume <- plot_data$Interpolated_Volume
    }

    tc_ratios <- T.C_ratio(plot_data, last.measure.day = params$main_avgplot.day)

    plotAvgGrowthBar(tc_ratios)

    shiny::setProgress(0.15)
```

```{r average plot option text, results='asis', echo=FALSE}

    cat("The average response plot was computed on (or near) day: ")
    cat(paste("**",params$main_avgplot.day,"**.",sep=""))

    if (params$main_avgplot_interpolate) {
        print("Data were interpolated for this plot.")
    }

```

### Log2 Fold Change Plot

```{r log2_foldchange, echo=FALSE}

    plot_data <- params$data_subset


    if (params$main_log2_interpolate){
        plot_data <- get_interpolated_pdx_data(data = plot_data)
        plot_data$Volume <- plot_data$Interpolated_Volume
    }

    vc_change <- IndividualMouseResponse(plot_data, last.measure.day = params$main_log2fold.day)

    log2FoldPlot(vc_change, caption_text_on = F, point_size = 1)

    shiny::setProgress(0.2)
```

```{r log2 fold change plot option text, results='asis', echo=FALSE}

    cat("The log2 fold change plot was computed on (or near) day: ")
    cat(paste("**",params$main_log2fold.day,"**.",sep=""))

    if (params$main_log2_interpolate) {
        print("Data were interpolated for this plot.")
    }

```

### Hybrid Waterfall Plot

```{r hybrid waterfall, echo=FALSE}

    plot_data <- params$data_subset

    if (params$main_tc_interpolate){
        plot_data <- get_interpolated_pdx_data(data = plot_data)
        plot_data$Volume <- plot_data$Interpolated_Volume
    }

    tc_ratios <- T.C_ratio(plot_data, last.measure.day = params$main_TC.day)

    WaterfallPlot_Hybrid(tc_ratios)

    shiny::setProgress(0.3)
```

```{r hybrid waterfall plot option text, results='asis', echo=FALSE}

    cat("The hybrid waterfall plot was computed on (or near) day: ")
    cat(paste("**",params$main_TC.day,"**.",sep=""))

    if (params$main_tc_interpolate) {
        print("Data were interpolated for this plot.")
    }

```

### Tumor Growth Inhibition

#### TGI Plot

```{r TGI plot, echo=FALSE}

    plot_data <- params$data_subset

    if (params$main_tgi_interpolate){
        plot_data = get_interpolated_pdx_data(data = plot_data)
        plot_data$Volume <- plot_data$Interpolated_Volume
    }

    tc_ratios <- T.C_ratio(plot_data, last.measure.day = params$main_TGI.day)

    #plot_measure = c('TC.ratio', 'aov.TC.ratio')
    plotTC.ratio(tc_ratios, plot_measure = 'aov.TC.ratio' )
    # NOTE: aov.TC.ratio is used in manuscript.

    shiny::setProgress(0.4)
```

```{r TGI option text, results='asis', echo=FALSE}

    cat("Tumor growth inhibition was computed on (or near) day: ")
    cat(paste("**",params$main_TGI.day,"**.",sep=""))

    if (params$main_tgi_interpolate) {
        print("Data were interpolated for this plot.")
    }

```

#### TGI Table

```{r TGI Table, results='asis', echo=FALSE}

    plot_data <- params$data_subset


    if (params$main_tgi_interpolate){
        plot_data = get_interpolated_pdx_data(data = plot_data)
        plot_data$Volume <- plot_data$Interpolated_Volume
    }

    response_list = list()
    response_list <- T.C_ratio(plot_data, last.measure.day = params$main_TGI.day)

    response_list <- response_list %>% dplyr::select(-mean.TVratio,	-var.TVratio,	-mean.dVt, -TC.ratio) %>%
                                    dplyr::select(Contributor, Study, Tumor, Arms, TC.CalcDay, n.TVratio, aov.TC.ratio, se_TC.ratio, Contrast.pValue) %>%
                                    dplyr::rename(pValue = Contrast.pValue)

    # cat(knitr::knit_print(DT::datatable(response_list[order(response_list$Arms),],
    #         style = "bootstrap",
    #         escape = FALSE,
    #         filter = 'none',
    #         rownames= FALSE,
    #         extensions = "Buttons",
    #         options = list(
    #             dom = "Blrtip", scrollX = TRUE, ordering = F, keys = TRUE, lengthMenu = list(c(5, 20, 50, -1), c('5', '20', '50', 'All')), pageLength = 20, paging = T,
    #             buttons = list("copy", list(extend = "collection", buttons = c("csv", "excel"), text = "Download")))) %>%
    #         formatRound(c('aov.TC.ratio', 'se_TC.ratio'), digits = 2) %>%
    #         formatSignif(c('pValue'), 2)))

    shiny::setProgress(0.45)
```

### Stacked Objective Response Plot

```{r Stacked ORC Plot, echo=FALSE}

    plot_data <- params$data_subset

    if (params$main_stackedorc_interpolate){
        plot_data <- get_interpolated_pdx_data(data = plot_data)
        plot_data$Volume <- plot_data$Interpolated_Volume
    }

    vc_change <- IndividualMouseResponse(plot_data, last.measure.day = params$main_orc.day)

    plotStackedORC(vc_change)

    shiny::setProgress(0.5)
```

```{r stacked ORC option text, results='asis', echo=FALSE}

    cat("Tumor growth inhibition was computed on (or near) day: ")
    cat(paste("**",params$main_orc.day,"**.",sep=""))

    if (params$main_stackedorc_interpolate) {
        print("Data were interpolated for this plot.")
    }

```

## Individual Study Plots & Analysis

Individual Study Plots 

### Individual Study ORC{.tabset}

###### FIX THE TABSETS THEY DON'T WORK IN A PDF FRAMEWORK! 

```{r individual study ORC plot, results='asis', echo=FALSE, out.width="50%"}

plot_data <- params$data_subset

    for (study in levels(as.factor(plot_data$Study))) {

        cat("#### Study", study, "\n")
        cat("\n")

        df <- base::subset(
            plot_data, Study %in% c(study)
        )

        df <- droplevels(df)

        if (params$tv_interpolate){
            df = get_interpolated_pdx_data(data = df)
            df$Volume <- df$Interpolated_Volume
        }

        study <- unlist(levels(factor(df$Study)))[1]

        filtered.df <- df %>%
        filter(Study == study) %>% droplevels()

        p1 <- study_volume_plot(filtered.df, position.dodge = 0.2, title = paste('Study:', study))

        p1 <- p1 + geom_vline(xintercept = params$tv_recist.day, linetype="dashed",
                            color = "black", size=1.2)

        p1 <- p1 + xlab("Time (d)") + ylab("Tumor Volume (mm3)")

        print(p1)

        response_list = list()
        response_list[[study]] <- get_response_level(filtered.df, last.measure.day = params$recist.day)$Response.Level
        response_list[[study]]$Study <- study


        if ('Control'%in%unique(response_list[[study]]$Arms)){
        response_list[[study]]$Arms <- relevel(factor(response_list[[study]]$Arms), 'Control')
        }

        response_list[[study]]$Response.Level <- factor(response_list[[study]]$Response.Level)

        response_list[[study]] <- response_list[[study]] %>% dplyr::select(-Study)

        cat(kable(response_list[[study]][order(response_list[[study]]$Arms),]) %>%
        kableExtra::kable_styling(full_width = FALSE, position = "float_right"))


        # cat(knitr::knit_print(DT::datatable(response_list[[study]][order(response_list[[study]]$Arms),],
        #         style = "bootstrap",
        #         escape = FALSE,
        #         filter = 'none',
        #         rownames= FALSE,
        #         extensions = "Buttons",
        #         options = list(
        #             dom = "Blrtip", scrollX = TRUE, ordering = F, keys = TRUE, lengthMenu = list(c(5, 20, 50, -1), c('5', '20', '50', 'All')), pageLength = 20, paging = T,
        #             buttons = list("copy", list(extend = "collection", buttons = c("csv", "excel"), text = "Download")))) %>%
        #         formatRound(c('Best.Response', 'Avg.Response'), digits = 2)))

        cat("\n")

        cat("\n")
    }

    shiny::setProgress(0.6)
```

### Individual Study Waterfall

```{r individual study waterfall, echo=FALSE}

    df <- base::subset(
        params$data_subset, Study %in% c(params$tv_study_filtered)
    )
    
    df <- droplevels(df)

    study <- unlist(levels(factor(df$Study)))[1]

    filtered.df <- df %>%
    dplyr::filter(Study == study) %>% droplevels()

    if (params$tv_waterfall_interpolate) {
        filtered.df = get_interpolated_pdx_data(data = filtered.df)
        filtered.df$Volume <- filtered.df$Interpolated_Volume
    }

    resp <- IndividualMouseResponse(filtered.df, last.measure.day = params$tv_AUC.day.waterfall)

    WaterfallPlot_PDX(resp, params$waterfall_metric)

    shiny::setProgress(0.7)
```

### Event Free Survival

```{r EFS, echo=FALSE}

    df <- base::subset(
    params$data_subset, Study %in% c(params$tv_study_filtered)
    )
    
    df <- droplevels(df)

    study <- unlist(levels(factor(df$Study)))[1]

    filtered.df <- df %>%
    dplyr::filter(Study == study) %>% droplevels()

    p1 <- EFSplot(filtered.df, params$tv_PercChange_EventSize)

    p1

    shiny::setProgress(0.8)
```

### ANOVA

```{r ANOVA, echo=FALSE}

    aov_res <- response_analysis(params$data_subset,
                    method = 'endpoint.ANOVA', 
                    last.measure.day = params$anova_Measure_Day, 
                    multi_test_anova = FALSE, 
                    tv_study_filtered = params$tv_study_filtered, 
                    tv_tumor_filtered = params$tv_tumor_filtered, 
                    main_anova_interpolate = params$main_anova_interpolate,
                    report = TRUE)

    kable(aov_res$anova[[1]]) %>%
        kableExtra::kable_styling(full_width = FALSE, position = "float_left")

    mct <- as.data.frame(aov_res$mct[['Arms']])
    mct$'diff' <- round(mct$'diff', digits=2)
    mct$'lwr' <- round(mct$'lwr', digits=2)
    mct$'upr' <- round(mct$'upr', digits=2)
    mct$'p adj' <- round(mct$'p adj', digits=4)

    kable(mct) %>%
        kableExtra::kable_styling(full_width = FALSE, position = "left")

    shiny::setProgress(0.9)
```

```{r Body_Weight, echo=FALSE}
    #   # Get Level Type Input by User
    if (params$tv_weight_plot_type == "Treatment Plot") {
        pattern_type <- "Treatment"
    } else if (params$tv_weight_plot_type == "Study Plot") {
        pattern_type <- "Study"
    }

    if (params$tv_weight_plot_style == "Study Average") {
        level_type <- "Arm"
    } else if (params$tv_weight_plot_style == "Individual Animal") {
        level_type <- "Animal"
    }

    if (params$tv_weight_plotType == 'Percent Change'){
        data <- params$data_subset %>%
            dplyr::arrange(Study, Tumor, Arms, ID, Times) %>%
            dplyr::group_by(Study, Tumor, Arms, ID) %>%
            dplyr::mutate(dWeight = (((Body_Weight - Body_Weight[1]) / Body_Weight[1] ) * 100))

        data$Body_Weight <- params$data$dWeight
    } else {
        data <- params$data_subset
    }
    #   # Call plot
    get_weight_plot(data = data, level = level_type, pattern = pattern_type, position.dodge = 0.2, tv_weight_plotType = params$tv_weight_plotType)
    
    shiny::setProgress(1)
```


<!-- For individual studies, we should loop over all studies to make a complete report. -->
<!-- For ANOVA, not only do we need to loop over study, but also over tumor as 'tumor' is a selection --> 
